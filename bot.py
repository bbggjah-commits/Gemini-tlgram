import os
import logging
from dotenv import load_dotenv
import google.generativeai as genai
from telegram import Update
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes

# ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦ÙŠØ©
load_dotenv()

# Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)

# Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØªÙˆÙƒÙ†Ø§Øª Ù…Ù† Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦ÙŠØ©
TELEGRAM_TOKEN = os.getenv('TELEGRAM_BOT_TOKEN')
GEMINI_API_KEY = os.getenv('GEMINI_API_KEY')

# ØªÙƒÙˆÙŠÙ† Gemini API
genai.configure(api_key=GEMINI_API_KEY)
model = genai.GenerativeModel('gemini-pro')

# Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø¨ÙˆØª
async def start_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        'Ù…Ø±Ø­Ø¨Ø§Ù‹! Ø£Ù†Ø§ Ø¨ÙˆØª Ù…Ø¯Ø¹ÙˆÙ… Ø¨Ù€ Gemini AI. ğŸš€\n\n'
        'ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØ­Ø¯Ø« Ù…Ø¹ÙŠ Ù…Ø¨Ø§Ø´Ø±Ø© Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ø§Ù…:\n'
        '/help - Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª\n'
        '/about - Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ù† Ø§Ù„Ø¨ÙˆØª'
    )

async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    help_text = """
ğŸ“– **Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø¨ÙˆØª:**

/start - Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
/help - Ø¹Ø±Ø¶ Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª
/about - Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ù† Ø§Ù„Ø¨ÙˆØª
/api_info - ÙƒÙŠÙÙŠØ© Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Gemini API

ğŸ’¬ **Ø¨Ø¨Ø³Ø§Ø·Ø© Ø£Ø±Ø³Ù„ Ø±Ø³Ø§Ù„Ø© ÙˆØ³Ø£Ø±Ø¯ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Gemini AI!**
    """
    await update.message.reply_text(help_text)

async def about_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    about_text = """
ğŸ¤– **Ø¨ÙˆØª Gemini Ù„Ù„ØªÙ„Ø¬Ø±Ø§Ù…**

- Ø§Ù„Ù…Ø·ÙˆØ±: [Ø§Ø³Ù…Ùƒ]
- Ø§Ù„Ø¥ØµØ¯Ø§Ø±: 1.0
- Ø§Ù„Ù…Ø¯Ø¹ÙˆÙ… Ø¨Ù€: Google Gemini AI
- Ø§Ù„Ù‡Ø¯Ù: ØªÙ‚Ø¯ÙŠÙ… Ù…Ø³Ø§Ø¹Ø¯Ø© Ø°ÙƒÙŠØ© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
    """
    await update.message.reply_text(about_text)

async def api_info_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    api_info = """
ğŸ”‘ **ÙƒÙŠÙÙŠØ© Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Gemini API:**

1. Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰: https://makersuite.google.com/app/apikey
2. Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø­Ø³Ø§Ø¨ Google
3. Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ "Create API Key"
4. Ø§Ù†Ø³Ø® Ø§Ù„Ù…ÙØªØ§Ø­ ÙˆØ§Ø­ÙØ¸Ù‡
5. Ø£Ø¶ÙÙ‡ Ø¥Ù„Ù‰ Ù…Ù„Ù .env ÙƒÙ€:
   GEMINI_API_KEY=your_api_key_here

âš ï¸ **ØªØ­Ø°ÙŠØ±:** Ù„Ø§ ØªØ´Ø§Ø±Ùƒ Ù…ÙØªØ§Ø­ API Ù…Ø¹ Ø£Ø­Ø¯!
    """
    await update.message.reply_text(api_info)

# Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù†ØµÙŠØ©
async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_message = update.message.text
    
    try:
        # Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© "ÙŠÙƒØªØ¨..." Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±
        typing_message = await update.message.reply_text("ğŸ”„ ÙŠÙÙƒØ±...")
        
        # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø¯ Ù…Ù† Gemini
        response = model.generate_content(user_message)
        
        # Ø­Ø°Ù Ø±Ø³Ø§Ù„Ø© "ÙŠÙƒØªØ¨..."
        await typing_message.delete()
        
        # Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯ (ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø·ÙˆÙŠÙ„Ø©)
        if response.text:
            if len(response.text) > 4096:
                # ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø·ÙˆÙŠÙ„Ø©
                for i in range(0, len(response.text), 4096):
                    await update.message.reply_text(response.text[i:i+4096])
            else:
                await update.message.reply_text(response.text)
        else:
            await update.message.reply_text("âš ï¸ Ù„Ù… Ø£Ø³ØªØ·Ø¹ ØªÙˆÙ„ÙŠØ¯ Ø±Ø¯. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.")
            
    except Exception as e:
        logging.error(f"Error: {e}")
        await update.message.reply_text("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø·Ù„Ø¨Ùƒ.")

# Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
async def error_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    logging.error(f"Update {update} caused error {context.error}")

# Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
def main():
    # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
    application = Application.builder().token(TELEGRAM_TOKEN).build()
    
    # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø§Øª
    application.add_handler(CommandHandler("start", start_command))
    application.add_handler(CommandHandler("help", help_command))
    application.add_handler(CommandHandler("about", about_command))
    application.add_handler(CommandHandler("api_info", api_info_command))
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))
    application.add_error_handler(error_handler)
    
    # Ø¨Ø¯Ø¡ Ø§Ù„Ø¨ÙˆØª
    print("ğŸ¤– Ø§Ù„Ø¨ÙˆØª ÙŠØ¹Ù…Ù„...")
    application.run_polling()

if __name__ == '__main__':
    main()
